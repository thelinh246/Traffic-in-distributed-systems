<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Demo Network Traffic - Topology View</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 360px;
      padding: 20px;
      border-right: 1px solid #1e293b;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      overflow-y: auto;
    }
    .sidebar h1 {
      font-size: 1.2rem;
      margin: 0 0 8px;
    }
    .sidebar p {
      font-size: 0.9rem;
      color: #9ca3af;
      margin: 0 0 12px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 118, 110, 0.15);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      color: #a5f3fc;
      margin-bottom: 10px;
    }
    .badge span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }
    .panel {
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #1e293b;
    }
    .panel h2 {
      font-size: 0.95rem;
      margin: 0 0 8px;
    }
    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      font-size: 0.8rem;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .legend-swatch {
      width: 18px;
      height: 3px;
      border-radius: 999px;
    }
    .sev-low { background: #22c55e; }
    .sev-medium { background: #eab308; }
    .sev-high { background: #ef4444; }
    .sev-critical { background: #a855f7; }
    .legend-core { background: #38bdf8; }
    .legend-access { background: #64748b; }

    .route-form {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.85rem;
    }
    .route-form select,
    .route-form button {
      font-size: 0.85rem;
    }
    select {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 8px;
      color: #e5e7eb;
      padding: 4px 8px;
      outline: none;
    }
    select:focus {
      border-color: #38bdf8;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
    button:hover {
      filter: brightness(1.05);
    }
    .route-info {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9ca3af;
      max-height: 140px;
      overflow: auto;
    }

    /* Bảng trạng thái link */
    .link-table {
      width: 100%;
      font-size: 0.75rem;
      border-collapse: collapse;
      margin-top: 4px;
    }
    .link-table th,
    .link-table td {
      padding: 3px 4px;
      border-bottom: 1px solid #1f2933;
      text-align: left;
      white-space: nowrap;
    }
    .link-table th {
      color: #9ca3af;
      font-weight: 500;
    }
    .link-table td {
      color: #e5e7eb;
    }
    .link-sev-LOW { color: #22c55e; }
    .link-sev-MEDIUM { color: #eab308; }
    .link-sev-HIGH { color: #ef4444; }
    .link-sev-CRITICAL { color: #a855f7; }

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 6px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
      display: inline-block;
    }
    .svg-wrapper {
      flex: 1;
      border-radius: 16px;
      background: radial-gradient(circle at top, #020617, #020617);
      border: 1px solid #1e293b;
      padding: 12px;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .node-label {
      font-size: 11px;
      fill: #e5e7eb;
      text-anchor: middle;
    }
    .node-circle {
      fill: #0f172a;
      stroke: #38bdf8;
      stroke-width: 1.5;
    }
    .node-router {
      stroke: #22c55e;
    }
    .node-switch {
      stroke: #eab308;
    }
    .node-host {
      stroke: #a855f7;
    }
    .link {
      stroke-width: 3;
      stroke-linecap: round;
      transition: stroke 0.25s ease, stroke-width 0.25s ease, opacity 0.25s ease;
    }
    .link-access {
      stroke: #64748b;
      stroke-width: 2.2;
      opacity: 0.7;
    }
    .link-core {
      stroke: #38bdf8;
    }
    .link-in-route {
      stroke-width: 5;
      filter: drop-shadow(0 0 4px rgba(56, 189, 248, 0.9));
    }
    .link-low { stroke: #22c55e; }
    .link-medium { stroke: #eab308; }
    .link-high { stroke: #ef4444; }
    .link-critical {
      stroke: #a855f7;
      stroke-dasharray: 6 3;
    }
    .link-label {
      font-size: 10px;
      fill: #9ca3af;
      text-anchor: middle;
    }
    .footer {
      font-size: 0.75rem;
      color: #6b7280;
      padding-top: 4px;
      border-top: 1px solid #111827;
      margin-top: 4px;
    }
    .error {
      color: #f97316;
    }
    .route-highlight-label {
      font-weight: 500;
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="badge">
      <span class="dot"></span>
      <span>Distributed Network Traffic Demo</span>
    </div>
    <h1>Sơ đồ mạng &amp; Traffic</h1>
    <p>
      Topology gồm <b>host – switch – router</b>. Màu link core (L1–L5)
      thể hiện severity lấy từ backend.
    </p>

    <div class="panel">
      <h2>Chú thích màu</h2>
      <div class="legend-row">
        <div class="legend-item">
          <div class="legend-swatch legend-access"></div><span>Access link (A1–A4)</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch legend-core"></div><span>Core link (L1–L5)</span>
        </div>
      </div>
      <div class="legend-row" style="margin-top: 6px;">
        <div class="legend-item">
          <div class="legend-swatch sev-low"></div><span>LOW</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch sev-medium"></div><span>MEDIUM</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch sev-high"></div><span>HIGH</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch sev-critical"></div><span>CRITICAL</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Route gợi ý (core)</h2>
      <form class="route-form" id="route-form">
        <span>Từ</span>
        <select id="src-select">
          <option value="R1">R1</option>
          <option value="R2">R2</option>
          <option value="R3">R3</option>
          <option value="R4">R4</option>
        </select>
        <span>đến</span>
        <select id="dst-select">
          <option value="R4">R4</option>
          <option value="R1">R1</option>
          <option value="R2">R2</option>
          <option value="R3">R3</option>
        </select>
        <button type="submit">Tính route</button>
      </form>
      <div class="route-info" id="route-info">
        Chọn cặp router và bấm <b>Tính route</b> để xem đường đi tối ưu
        (dựa trên severity + latency).
      </div>
    </div>

    <div class="panel">
      <h2>Trạng thái link (/links)</h2>
      <div id="link-list">
        Đang chờ dữ liệu...
      </div>
    </div>

    <div class="footer">
      Backend API: <code>http://localhost:8000</code><br />
      Nhớ chạy Kafka, Producer, Alert Engine và API trước khi mở trang này.
    </div>
  </div>

  <div class="main">
    <div class="top-bar">
      <div>
        <span class="status-dot"></span>
        <span>Đang đọc trạng thái link từ API <code>/links</code> (2s/lần)</span>
      </div>
      <div id="refresh-status">Chưa cập nhật</div>
    </div>
    <div class="svg-wrapper">
      <svg id="topology" viewBox="0 0 1100 420"></svg>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost:8000";

    // Node: host, switch, router
    const nodes = {
      H1:  { x: 90,  y: 220, type: "host",   label: "H1" },
      SW1: { x: 210, y: 220, type: "switch", label: "SW1" },
      R1:  { x: 360, y: 170, type: "router", label: "R1" },
      R2:  { x: 540, y: 170, type: "router", label: "R2" },
      R3:  { x: 540, y: 290, type: "router", label: "R3" },
      R4:  { x: 730, y: 230, type: "router", label: "R4" },
      SW2: { x: 900, y: 230, type: "switch", label: "SW2" },
      H2:  { x: 1020,y: 230, type: "host",   label: "H2" },
    };

    // Links: access + core
    const links = [
      // Access (L2)
      { id: "A1", from: "H1",  to: "SW1", core: false },
      { id: "A2", from: "SW1", to: "R1",  core: false },
      { id: "A3", from: "H2",  to: "SW2", core: false },
      { id: "A4", from: "SW2", to: "R4",  core: false },
      // Core (L3)
      { id: "L1", from: "R1", to: "R2", core: true },
      { id: "L2", from: "R2", to: "R3", core: true },
      { id: "L3", from: "R1", to: "R3", core: true },
      { id: "L4", from: "R3", to: "R4", core: true },
      { id: "L5", from: "R2", to: "R4", core: true },
    ];

    const svg = document.getElementById("topology");
    const refreshStatus = document.getElementById("refresh-status");
    const routeInfo = document.getElementById("route-info");
    const linkListDiv = document.getElementById("link-list");

    function createSvgElement(tag, attrs) {
      const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
      for (const [k, v] of Object.entries(attrs)) {
        el.setAttribute(k, v);
      }
      return el;
    }

    function drawTopology() {
      // Vẽ link + label
      for (const link of links) {
        const n1 = nodes[link.from];
        const n2 = nodes[link.to];
        const line = createSvgElement("line", {
          id: link.id,
          x1: n1.x,
          y1: n1.y,
          x2: n2.x,
          y2: n2.y,
          class: "link " + (link.core ? "link-core" : "link-access"),
        });
        svg.appendChild(line);

        // label tên link (A1..A4, L1..L5)
        const mx = (n1.x + n2.x) / 2;
        const my = (n1.y + n2.y) / 2;
        const t = createSvgElement("text", {
          x: mx,
          y: my - 6,
          class: "link-label",
        });
        t.textContent = link.id;
        svg.appendChild(t);
      }

      // Vẽ node
      for (const [id, n] of Object.entries(nodes)) {
        const circle = createSvgElement("circle", {
          cx: n.x,
          cy: n.y,
          r: 16,
          class: "node-circle node-" + n.type,
        });
        svg.appendChild(circle);

        const label = createSvgElement("text", {
          x: n.x,
          y: n.y + 4,
          class: "node-label",
        });
        label.textContent = id;
        svg.appendChild(label);
      }
    }

    function clearRouteHighlight() {
      for (const link of links) {
        const line = document.getElementById(link.id);
        if (!line) continue;
        line.classList.remove("link-in-route");
      }
    }

    function applySeverityStyles(severityMap) {
      // severityMap: { L1: { severity: "HIGH", ... }, ... }
      for (const [linkId, st] of Object.entries(severityMap)) {
        const line = document.getElementById(linkId);
        if (!line) continue;

        line.classList.remove("link-low", "link-medium", "link-high", "link-critical");

        const sev = (st.severity || "LOW").toUpperCase();
        if (sev === "LOW") line.classList.add("link-low");
        else if (sev === "MEDIUM") line.classList.add("link-medium");
        else if (sev === "HIGH") line.classList.add("link-high");
        else if (sev === "CRITICAL") line.classList.add("link-critical");
      }
    }

    function renderLinkList(data) {
      const entries = Object.values(data);
      if (!entries.length) {
        linkListDiv.textContent = "Chưa có dữ liệu link.";
        return;
      }
      entries.sort((a, b) => a.link_id.localeCompare(b.link_id));

      let html = '<table class="link-table"><thead><tr>' +
        '<th>Link</th><th>Src</th><th>Dst</th><th>Sev</th>' +
        '<th>Util%</th><th>Lat(ms)</th><th>Loss%</th>' +
        '</tr></thead><tbody>';

      for (const st of entries) {
        const sev = (st.severity || "LOW").toUpperCase();
        const sevClass = "link-sev-" + sev;
        html += `<tr>
          <td>${st.link_id}</td>
          <td>${st.src}</td>
          <td>${st.dst}</td>
          <td class="${sevClass}">${sev}</td>
          <td>${st.utilization_pct ?? "?"}</td>
          <td>${st.latency_ms ?? "?"}</td>
          <td>${st.packet_loss_pct ?? "?"}</td>
        </tr>`;
      }
      html += "</tbody></table>";
      linkListDiv.innerHTML = html;
    }

    async function refreshLinks() {
      try {
        const res = await fetch(apiBase + "/links");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        applySeverityStyles(data);
        renderLinkList(data);

        const now = new Date();
        refreshStatus.textContent = "Cập nhật: " + now.toLocaleTimeString();
        refreshStatus.classList.remove("error");
      } catch (err) {
        refreshStatus.textContent = "Không gọi được /links: " + err.message;
        refreshStatus.classList.add("error");
        linkListDiv.innerHTML = '<span class="error">Lỗi gọi /links: ' + err.message + "</span>";
      }
    }

    async function requestRoute(src, dst) {
      clearRouteHighlight();
      routeInfo.textContent = "Đang tính route...";
      try {
        const url = apiBase + "/route?src=" + encodeURIComponent(src) + "&dst=" + encodeURIComponent(dst);
        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text();
          throw new Error("HTTP " + res.status + " - " + txt);
        }
        const data = await res.json();

        // highlight path
        if (Array.isArray(data.path_links)) {
          for (const lid of data.path_links) {
            const line = document.getElementById(lid);
            if (line) {
              line.classList.add("link-in-route");
            }
          }
        }

        let html = "";
        html += `<div class="route-highlight-label">Route: ${data.src} → ${data.dst}</div>`;
        html += `<div>Path links: <b>${data.path_links.join(" → ") || "(trống)"}</b></div>`;
        html += `<div style="margin-top:4px;">Chi tiết từng link:</div>`;
        html += "<ul>";
        for (const seg of data.segments || []) {
          html += `<li>${seg.link_id}: severity=${seg.severity || "?"}, util=${seg.utilization_pct ?? "?"}%, latency=${seg.latency_ms ?? "?"}ms</li>`;
        }
        html += "</ul>";
        routeInfo.innerHTML = html;
      } catch (err) {
        routeInfo.innerHTML = `<span class="error">Lỗi gọi /route: ${err.message}</span>`;
      }
    }

    // Init
    drawTopology();
    refreshLinks();
    setInterval(refreshLinks, 2000);

    const form = document.getElementById("route-form");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const src = document.getElementById("src-select").value;
      const dst = document.getElementById("dst-select").value;
      if (src === dst) {
        routeInfo.innerHTML = '<span class="error">Nguồn và đích phải khác nhau.</span>';
        clearRouteHighlight();
        return;
      }
      requestRoute(src, dst);
    });
  </script>
</body>
</html>
